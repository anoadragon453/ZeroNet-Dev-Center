<!DOCTYPE html>
<html lang="en">
<head>
	<title>ZeroNet Dev Center</title>
	<meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="keywords" content="zite,zites,important,krixano,list,category,search,filter">
	<meta name="author" content="Krixano">
	<base href="" target="_top" id="base">
	<script>base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/[&?]wrapper=False/, "").replace(/[&?]wrapper_nonce=[A-Za-z0-9]+/, "")</script>

	<link rel="stylesheet" href="css/buefy.css" />
	<link rel="stylesheet" href="css/main.css" />

	<script src="js/navToggle.js" defer></script>
</head>
<body>
	<div id="app">
		<my-hero v-bind:class="{ 'is-medium': heroIsMedium }" v-bind:title="heroTitle" v-bind:subtitle="heroSubtitle">
			<div v-html="heroContent"></div>
		</my-hero>

		<component v-bind:is="currentView" v-bind:tutorials-list="tutorialsList" v-bind:tutorial-content="tutorialContent" v-bind:tutorial-comments="tutorialComments" v-bind:questions-list="questionsList" v-bind:question-id="questionID" v-bind:answers-list="answersList"></component>

		<my-footer></my-footer>
	</div>

	<script type="text/javascript" src="js/ZeroFrame.js"></script>

	<!-- Vue & Router -->
	<script type="text/javascript" src="js/vue.min.js"></script>
	<script type="text/javascript" src="js/router.js"></script>
	<script type="text/javascript" src="js/vue-router-link.js"></script>
	<script type="text/javascript" src="js/vueComponents.js"></script>
	<script type="text/javascript" src="js/vueRoutes.js"></script>

	<script type="text/javascript" src="js/buefy.js"></script>

	<!-- Markdown-It -->
	<script type="text/javascript" src="js/markdown-it/markdown-it.min.js"></script>
	<script type="text/javascript" src="js/markdown-it/markdown-it-footnote.min.js"></script>
	<script type="text/javascript" src="js/markdown-it/markdown-it-emoji-light.min.js"></script>
	<script type="text/javascript" src="js/markdown-it/markdown-it-abbr.min.js"></script>
	<script type="text/javascript" src="js/markdown-it/markdown-it-deflist.min.js"></script>
	
	<script>
		var md = window.markdownit();
		md.use(window.markdownitFootnote);
		md.use(window.markdownitEmoji);
		md.use(window.markdownitAbbr);
		md.use(window.markdownitDeflist);
		md.set({ html: true });

		Vue.use(Buefy);

		var app = new Vue({
			data: {
				currentView: 'route-home',
				heroIsMedium: true,
				heroTitle: "",
				heroSubtitle: "",
				heroContent: "",
				tutorialsList: [],
				tutorialID: null,
				tutorialContent: "",
				tutorialComments: [],
				questionsList: [],
				questionID: null,
				answersList: []
			}
		}).$mount('#app');

		class ZeroApp extends ZeroFrame {
			onOpenWebsocket () {
				this.cmd("siteInfo", {}, (site_info) => {
					if (site_info.cert_user_id)
						document.getElementById("select_user").innerText = site_info.cert_user_id
					this.site_info = site_info
				});
				this.cmd("wrapperNotification", ["info", "This is the DEV version of the zite."]);
			}

			selectUser () {
				this.cmd("certSelect", {accepted_domains: ["zeroid.bit", "kaffie.bit", "cryptoid.bit"]})
				return false
			}

			onRequest (cmd, message) {
				if (cmd == "setSiteInfo") {
					this.site_info = message.params  // Save site info data to allow access it later
					if (message.params.cert_user_id){
						document.getElementById("select_user").innerHTML = message.params.cert_user_id
					} else if (!message.params.cert_user_id) {
						document.getElementById("select_user").innerHTML = "Select user"
					}
					if (message.params.event[0] == "file_done") {
						//this.loadZiteIndicator();
						checkTutorialsList();
						if (Router.currentRoute == "tutorials/:slug") {
							getComments(app.tutorialID);
						}
					}
				}

				Router.listenForBack(cmd, message);
			}
		}

		zeroframe = new ZeroApp();
		page = zeroframe; // For ZeroFrame Router
	</script>

	<script>
		Router.add("tutorials/:slug", route_tutorials_slug)
			.add("tutorials", route_tutorials)
			.add("questions/new", route_questions_new)
			.add("questions/:id/answer", route_questions_id_answer)
			.add("questions/:id", route_questions_id)
			.add("questions", route_questions)
			.add(route_home)
			.hooks({
				after: function(currentRoute, params) {
					app.currentView = 'route-' + currentRoute.replace(/:/, '').replace(/\//g, '-');
					if (currentRoute == '') {
						app.currentView = 'route-home';
					}
				}
			}).init();

		function route_home(params) {
			var subtitle = "Tutorials, Questions, Collaboration";
			var content = generateRouteLinkHTML('tutorials/the_basics', 'The Basics', 'button is-info') + 
							generateRouteLinkHTML('tutorials', 'All Tutorials', '', 'margin-top: 10px; margin-left: 10px;');

			setupHero(true, "ZeroNet Dev Center", subtitle, content);
			checkTutorialsList();
			getQuestionsList();
		}

		function route_tutorials(params) {
			setupHero(false, "Tutorials", "");
			checkTutorialsList();
		}

		function route_tutorials_slug(params) {
			setupHero(false, "", "");
			getTutorial(params.slug);
			console.log(Router.currentRoute);
		}

		function route_questions(params) {
			setupHero(false, "Questions", "");
			getQuestionsList();
		}

		function route_questions_new(params) {
			setupHero(false, "Questions", "");
			getQuestionsList();
		}

		function route_questions_id(params) {
			setupHero(false, "Questions", "");
			getQuestion(params.id);
			getAnswersList(params.id);
		}

		function route_questions_id_answer(params) {
			setupHero(false, "Questions", "");
			getQuestion(params.id);
		}

		function setupHero(isMedium, title, subtitle, content = "") {
			if (isMedium != null) {
				app.heroIsMedium = isMedium;
			}
			if (title != null) {
				app.heroTitle = title;
			}
			if (subtitle != null) {
				app.heroSubtitle = subtitle;
			}
			if (content != null) {
				app.heroContent = content;
			}
		}

		function checkTutorialsList() { // TODO(krixano): Recache tutorial list when tutorials database changes
			if (app.tutorialsList.length == 0) {
				zeroframe.cmd('dbQuery', ['SELECT * FROM tutorials'], (tutorials) => {
					app.tutorialsList = tutorials;
				});
			}
		}

		function getTutorial(slug) { // TODO(krixano): Implement caching of last visited tutorial's text?
			if (slug) {
				var getTutorial = function(tutorials) {
					var tutorial = null;
						for (var i in tutorials) {
							if (tutorials[i].slug == slug) {
								tutorial = tutorials[i];
							}
						}

						if (tutorial) {
							zeroframe.cmd('fileGet', ['tutorials/' + tutorial.file], (content) => {
								app.heroTitle = tutorial.title;
								app.heroSubtitle = 'By ' + tutorial.author;
								app.tutorialContent = md.render(content);
								app.tutorialID = tutorial.id;
								// Get Comments
								getComments(tutorial.id);
							});
						} else {
							app.tutorialContent = "";
							app.heroTitle = 'Not Found';
							app.heroSubtitle = 'This page was not found!';
							// Router.navigate('not-found');
						}
				};

				if (app.tutorialsList.length == 0) {
					zeroframe.cmd('dbQuery', ['SELECT * FROM tutorials'], (tutorials) => getTutorial(tutorials));
				} else {
					getTutorial(app.tutorialsList);
				}
			}
		}

		function getComments(tutorialID) {
			zeroframe.cmd("dbQuery", ["SELECT * FROM comments LEFT JOIN json USING (json_id) WHERE tutorial_id=" + tutorialID + " ORDER BY date_added DESC"], (comments) => {
				app.tutorialComments = comments;
			});
		}

		function postComment() {
			// No account selected -> Display error
			if (!zeroframe.site_info.cert_user_id) {
				zeroframe.cmd("wrapperNotification", ["info", "Please, select your account."]);
				zeroframe.selectUser();
				return;
			}

			// This is the data file path
			var data_inner_path = "data/users/" + zeroframe.site_info.auth_address + "/data.json";
			var content_inner_path = "data/users/" + zeroframe.site_info.auth_address + "/content.json";

			// Load our current messages
			zeroframe.cmd("fileGet", {"inner_path": data_inner_path, "required": false}, (data) => {
				if (data)
					data = JSON.parse(data);
				else
					data = { "comments": [] }

				// Add the new message to data
				data.comments.push({
					"tutorial_id": app.tutorialID,
					"body": document.getElementById("comment").value,
					"date_added": Date.now()
				});

				// Encode data array to utf8 json text
				var json_raw = unescape(encodeURIComponent(JSON.stringify(data, undefined, '\t')));

				// Write file to disk
				zeroframe.cmd("fileWrite", [data_inner_path, btoa(json_raw)], (res) => {
					if (res == "ok") {
						// Reset the message input
						document.getElementById("comment").value = "";

						// Sign the changed file in our user's directory
						zeroframe.cmd("siteSign", {"inner_path": content_inner_path}, (res) => {
							// TODO(krixano): Reload Messages
							getComments(app.tutorialID);
							// Publish to other users
							zeroframe.cmd("sitePublish", {"inner_path": content_inner_path, "sign": false});
						});
					} else {
						zeroframe.cmd("wrapperNotification", ["error", "File write error: #{res}"]);
					}
				});
			});
		}

		function getQuestionsList() {
			if (app.tutorialsList.length == 0) {
				zeroframe.cmd('dbQuery', ['SELECT * FROM questions LEFT JOIN json USING (json_id) ORDER BY date_added DESC'], (questions) => {
					app.questionsList = questions;
				});
			}
		}

		function postQuestion() {
			// No account selected -> Display error
			if (!zeroframe.site_info.cert_user_id) {
				zeroframe.cmd("wrapperNotification", ["info", "Please, select your account."]);
				zeroframe.selectUser();
				return;
			}

			// This is the data file path
			var data_inner_path = "data/users/" + zeroframe.site_info.auth_address + "/data.json";
			var content_inner_path = "data/users/" + zeroframe.site_info.auth_address + "/content.json";

			// Load our current questions
			zeroframe.cmd("fileGet", {"inner_path": data_inner_path, "required": false}, (data) => {
				if (data)
					data = JSON.parse(data);
				else
					data = { "questions": [] }

				// Add the new question to data
				data.questions.push({
					"question_id": app.questionsList[0].question_id + 1, // Get last question's id and increment by 1
					"title": document.getElementById("questionTitle").value,
					"body": document.getElementById("questionBody").value,
					"date_added": Date.now()
				});

				// Encode data array to utf8 json text
				var json_raw = unescape(encodeURIComponent(JSON.stringify(data, undefined, '\t')));

				// Write file to disk
				zeroframe.cmd("fileWrite", [data_inner_path, btoa(json_raw)], (res) => {
					if (res == "ok") {
						// Reset the question input
						document.getElementById("questionTitle").value = "";
						document.getElementById("questionBody").value = "";

						// Sign the changed file in our user's directory
						zeroframe.cmd("siteSign", {"inner_path": content_inner_path}, (res) => {
							// TODO(krixano): Reload Questions List
							getQuestionsList();
							// Publish to other users
							zeroframe.cmd("sitePublish", {"inner_path": content_inner_path, "sign": false});
							Router.navigate("questions");
						});
					} else {
						zeroframe.cmd("wrapperNotification", ["error", "File write error: #{res}"]);
					}
				});
			});
		}

		function getQuestion(id) {
			if (id) {
				var getQuestion = function(questions) {
					var question = null;
						for (var i in questions) {
							if (questions[i].question_id == id) {
								question = questions[i];
							}
						}

						if (question) {
							app.heroTitle = question.title;
							app.heroSubtitle = '' + question.cert_user_id;
							app.tutorialContent = md.render(question.body);
							app.questionID = question.question_id;
							// Get Comments
						} else {
							app.tutorialContent = "";
							app.heroTitle = 'Not Found';
							app.heroSubtitle = 'This page was not found!';
							// Router.navigate('not-found');
						}
				};

				if (app.questionsList.length == 0) {
					zeroframe.cmd('dbQuery', ['SELECT * FROM questions LEFT JOIN json USING (json_id) ORDER BY date_added DESC'], (questions) => getQuestion(questions));
				} else {
					getQuestion(app.questionsList);
				}
			}
		}

		function getAnswersList(id) {
			if (app.answersList.length == 0) {
				zeroframe.cmd('dbQuery', ['SELECT * FROM answers LEFT JOIN json USING (json_id) ORDER BY date_added DESC'], (answers) => {
					console.log(id);
					app.answersList = answers;
				});
			}
		}

		function postAnswer() {
			// No account selected -> Display error
			if (!zeroframe.site_info.cert_user_id) {
				zeroframe.cmd("wrapperNotification", ["info", "Please, select your account."]);
				zeroframe.selectUser();
				return;
			}

			// This is the data file path
			var data_inner_path = "data/users/" + zeroframe.site_info.auth_address + "/data.json";
			var content_inner_path = "data/users/" + zeroframe.site_info.auth_address + "/content.json";

			// Load our current questions
			zeroframe.cmd("fileGet", {"inner_path": data_inner_path, "required": false}, (data) => {
				if (data)
					data = JSON.parse(data);
				else
					data = { "answers": [] }

				// Add the new question to data
				data.answers.push({
					"question_id": app.questionID, // Get last question's id and increment by 1
					"body": document.getElementById("answerBody").value,
					"date_added": Date.now()
				});

				// Encode data array to utf8 json text
				var json_raw = unescape(encodeURIComponent(JSON.stringify(data, undefined, '\t')));

				// Write file to disk
				zeroframe.cmd("fileWrite", [data_inner_path, btoa(json_raw)], (res) => {
					if (res == "ok") {
						// Reset the question input
						document.getElementById("answerBody").value = "";

						// Sign the changed file in our user's directory
						zeroframe.cmd("siteSign", {"inner_path": content_inner_path}, (res) => {
							// TODO(krixano): Reload Answers
							//
							// Publish to other users
							zeroframe.cmd("sitePublish", {"inner_path": content_inner_path, "sign": false});
							Router.navigate("questions/" + app.questionID);
						});
					} else {
						zeroframe.cmd("wrapperNotification", ["error", "File write error: #{res}"]);
					}
				});
			});
		}
	</script>
</body>
</html>